<div class="cleanup-header">
  <h1>Script Runs Cleanup</h1>
  <p>
    Clean up old script runs and their associated log files to free up storage
    space.
  </p>
</div>

<!-- Configuration Form -->
<div class="cleanup-form">
  <div class="form-section">
    <h3>Cleanup Configuration</h3>

    <div class="form-group">
      <label for="days">Days to Keep:</label>
      <input
        type="number"
        id="days"
        [ngModel]="days()"
        (ngModelChange)="days.set($event)"
        min="1"
        max="365"
        class="form-control"
      />
      <small
        >Runs older than this many days will be considered for cleanup</small
      >
    </div>

    <div class="form-group">
      <label for="status">Status Filter:</label>
      <select
        id="status"
        [ngModel]="status()"
        (ngModelChange)="status.set($event)"
        class="form-control"
      >
        <option *ngFor="let option of statusOptions" [value]="option.value">
          {{ option.label }}
        </option>
      </select>
      <small>Only clean up runs with this status</small>
    </div>

    <div class="form-actions">
      <button
        type="button"
        (click)="performDryRun()"
        [disabled]="isLoading()"
        class="btn btn-primary"
      >
        <span *ngIf="isLoading()" class="spinner"></span>
        Perform Dry Run
      </button>

      <button type="button" (click)="resetResults()" class="btn btn-secondary">
        Reset
      </button>
    </div>
  </div>
</div>

<!-- Error Display -->
<div *ngIf="error()" class="error-message">
  <div class="alert alert-error"><strong>Error:</strong> {{ error() }}</div>
</div>

<!-- Dry Run Results -->
<div *ngIf="dryRunResults()" class="results-section">
  <div class="results-header">
    <h3>Dry Run Results</h3>
    <div class="summary-cards">
      <div class="summary-card">
        <div class="card-value">{{ dryRunResults()!.summary.totalRuns }}</div>
        <div class="card-label">Total Runs</div>
      </div>
      <div class="summary-card">
        <div class="card-value">
          {{ dryRunResults()!.summary.logFilesToDelete }}
        </div>
        <div class="card-label">Log Files</div>
      </div>
      <div class="summary-card">
        <div class="card-value">
          {{ formatDate(dryRunResults()!.summary.cutoffDate) }}
        </div>
        <div class="card-label">Cutoff Date</div>
      </div>
    </div>
  </div>

  <!-- Status Breakdown -->
  <div class="breakdown-section">
    <h4>Runs by Status</h4>
    <div class="status-breakdown">
      <div
        *ngFor="let status of Object.keys(dryRunResults()!.summary.runsByStatus)"
        class="status-item"
      >
        <span class="status-badge" [class]="getStatusBadgeClass(status)">
          {{ status }}
        </span>
        <span class="status-count"
          >{{ dryRunResults()!.summary.runsByStatus[status] }}</span
        >
      </div>
    </div>
  </div>

  <!-- Script Breakdown -->
  <div class="breakdown-section">
    <h4>Runs by Script</h4>
    <div class="script-breakdown">
      <div
        *ngFor="let script of Object.keys(dryRunResults()!.summary.runsByScript)"
        class="script-item"
      >
        <span class="script-name">{{ script }}</span>
        <span class="script-count"
          >{{ dryRunResults()!.summary.runsByScript[script] }}</span
        >
      </div>
    </div>
  </div>

  <!-- Runs List -->
  <div class="runs-list">
    <h4>Runs to be Deleted ({{ dryRunResults()!.runs.length }})</h4>
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Script</th>
            <th>Status</th>
            <th>Start Time</th>
            <th>Log File</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let run of dryRunResults()!.runs">
            <td>{{ run.id }}</td>
            <td>{{ run.scriptName }}</td>
            <td>
              <span class="badge" [class]="getStatusBadgeClass(run.status)">
                {{ run.status }}
              </span>
            </td>
            <td>{{ formatDate(run.startTime) }}</td>
            <td>
              <span *ngIf="run.hasLogFile" class="log-file"
                >{{ run.logFile }}</span
              >
              <span *ngIf="!run.hasLogFile" class="no-log">No log file</span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Cleanup Action -->
  <div class="cleanup-action">
    <div class="confirmation-section">
      <label class="checkbox-label">
        <input
          type="checkbox"
          [ngModel]="confirm()"
          (ngModelChange)="confirm.set($event)"
        />
        <span class="checkmark"></span>
        I understand this action cannot be undone and will permanently delete {{
        dryRunResults()!.summary.totalRuns }} runs and {{
        dryRunResults()!.summary.logFilesToDelete }} log files.
      </label>
    </div>

    <button
      type="button"
      (click)="performCleanup()"
      [disabled]="!confirm() || isLoading()"
      class="btn btn-danger"
    >
      <span *ngIf="isLoading()" class="spinner"></span>
      Perform Cleanup
    </button>
  </div>
</div>

<!-- Cleanup Results -->
<div *ngIf="cleanupResults()" class="results-section">
  <div class="results-header">
    <h3>Cleanup Completed</h3>
    <div class="summary-cards">
      <div class="summary-card success">
        <div class="card-value">{{ cleanupResults()!.deletedRuns }}</div>
        <div class="card-label">Runs Deleted</div>
      </div>
      <div class="summary-card success">
        <div class="card-value">{{ cleanupResults()!.deletedLogFiles }}</div>
        <div class="card-label">Log Files Deleted</div>
      </div>
      <div class="summary-card">
        <div class="card-value">{{ cleanupResults()!.totalProcessed }}</div>
        <div class="card-label">Total Processed</div>
      </div>
    </div>
  </div>

  <!-- Errors if any -->
  <div *ngIf="cleanupResults()!.errors.length > 0" class="errors-section">
    <h4>Errors Encountered</h4>
    <div class="error-list">
      <div *ngFor="let error of cleanupResults()!.errors" class="error-item">
        {{ error }}
      </div>
    </div>
  </div>
</div>
